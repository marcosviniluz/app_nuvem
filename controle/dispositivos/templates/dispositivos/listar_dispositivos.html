{% extends 'core/base.html' %}

{% block title %}Dispositivos{% endblock %}

{% block content %}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
    .select2-container--open { z-index: 9999999 !important; }
    .select2-container .select2-selection--single {
        height: 38px !important;
        border: 1px solid #dee2e6 !important;
        display: flex;
        align-items: center;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Dispositivos</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalAddDispositivo">
        <i class="bi bi-plus-lg"></i> Adicionar Dispositivo
    </button>
</div>

<div class="card mb-3 bg-light border-0">
    <div class="card-body py-2">
        <div class="row">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                    <input type="text" id="inputBuscaCodigo" class="form-control border-start-0" placeholder="üîç Buscar por c√≥digo do dispositivo...">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- {% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endfor %}
{% endif %} -->

<div class="table-responsive">
    <table class="table table-striped align-middle" id="tabelaDispositivos">
        <thead>
            <tr>
                <th>C√≥digo</th>
                <th>Tipo</th>
                <th>Funcion√°rio</th>
                <th>Status</th>
                <th>Equipamentos Aux.</th>
                <th width="180">A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for dispositivo in dispositivos %}
            <tr>
                <td class="codigo-item"><strong>{{ dispositivo.codigo }}</strong></td>
                <td>{{ dispositivo.get_tipo_dispositivo_display }}</td>
                <td>
                    {% if dispositivo.funcionario %}
                        {{ dispositivo.funcionario.nome }}
                    {% else %}
                        <span class="text-muted">‚Äî</span>
                    {% endif %}
                </td>
                <td>
                    {% if dispositivo.status == 'ATIVO' %}
                        <span class="badge bg-success">Ativo</span>
                    {% elif dispositivo.status == 'MANUTENCAO' %}
                        <span class="badge bg-warning text-dark">Manuten√ß√£o</span>
                    {% else %}
                        <span class="badge bg-secondary">Dispon√≠vel</span>
                    {% endif %}
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-info btnEquipamentos"
                            data-id="{{ dispositivo.id }}"
                            data-codigo="{{ dispositivo.codigo }}">
                        Ver Itens
                    </button>
                </td>
                <td>
                    <button class="btn btn-sm btn-warning btnEditar"
                        data-url="{% url 'dispositivos:editar_dispositivo' dispositivo.id %}"
                        data-id="{{ dispositivo.id }}"
                        data-codigo="{{ dispositivo.codigo }}"
                        data-tipo="{{ dispositivo.tipo_dispositivo }}"
                        data-funcionario="{% if dispositivo.funcionario %}{{ dispositivo.funcionario.id }}{% endif %}"
                        data-status="{{ dispositivo.status }}">
                        Editar
                    </button>

                    <a href="{% url 'dispositivos:deletar_dispositivo' dispositivo.id %}" 
                       class="btn btn-sm btn-danger"
                       onclick="return confirm('Tem certeza que deseja excluir este dispositivo?')">
                       Excluir
                    </a>
                </td>
            </tr>
            {% empty %}
            <tr class="no-results"><td colspan="6" class="text-center">Nenhum dispositivo cadastrado.</td></tr>
            {% endfor %}
            <tr id="msgNenhumResultado" style="display: none;"><td colspan="6" class="text-center text-muted">Nenhum dispositivo encontrado com esse c√≥digo.</td></tr>
        </tbody>
    </table>
</div>

<div class="modal fade" id="modalAddDispositivo" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form action="{% url 'dispositivos:criar_dispositivo' %}" method="POST">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Adicionar Dispositivo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">C√≥digo</label>
                        <input type="text" name="codigo" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tipo</label>
                        <select name="tipo_dispositivo" class="form-select" required>
                            {% for value, label in tipos %}
                                <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Funcion√°rio</label>
                        <select name="funcionario" class="form-select select2-pessoa">
                            <option value="">‚Äî Nenhum ‚Äî</option>
                            {% for f in funcionarios %}
                                <option value="{{ f.id }}">{{ f.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditDispositivo" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="formEditar" method="POST">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Editar Dispositivo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">C√≥digo</label>
                        <input type="text" id="editCodigo" name="codigo" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tipo</label>
                        <select id="editTipo" name="tipo_dispositivo" class="form-select" required>
                            {% for value, label in tipos %}
                                <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Funcion√°rio</label>
                        <select id="editFuncionario" name="funcionario" class="form-select select2-pessoa">
                            <option value="">‚Äî Nenhum ‚Äî</option>
                            {% for f in funcionarios %}
                                <option value="{{ f.id }}">{{ f.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select id="editStatus" name="status" class="form-select" required>
                            {% for val, lab in status %}
                                <option value="{{ val }}">{{ lab }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEquipamentos" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" id="equipamentosContent">
            </div>
    </div>
</div>

<script>
$(document).ready(function() {

    // --- L√ìGICA DE BUSCA INSTANT√ÇNEA ---
    $("#inputBuscaCodigo").on("keyup", function() {
        var value = $(this).val().toLowerCase();
        var hasResult = false;

        $("#tabelaDispositivos tbody tr:not(#msgNenhumResultado):not(.no-results)").filter(function() {
            // Busca apenas na coluna do C√≥digo (que tem a classe .codigo-item)
            var textoCodigo = $(this).find(".codigo-item").text().toLowerCase();
            var mostrar = textoCodigo.indexOf(value) > -1;
            
            $(this).toggle(mostrar);
            if(mostrar) hasResult = true;
        });

        // Mostra mensagem se n√£o achou nada
        if (!hasResult && value !== "") {
            $("#msgNenhumResultado").show();
        } else {
            $("#msgNenhumResultado").hide();
        }
    });

    // --- SEUS SCRIPTS ORIGINAIS ---
    $('.select2-pessoa').each(function() {
        $(this).select2({
            placeholder: "Selecione o funcion√°rio",
            allowClear: true,
            width: '100%',
            dropdownParent: $(this).closest('.modal')
        });
    });

    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    });

    $(".btnEditar").click(function () {
        let url = $(this).data("url");
        let codigo = $(this).data("codigo");
        let tipo = $(this).data("tipo");
        let funcionario = $(this).data("funcionario") || "";
        let status = $(this).data("status") || "DISPONIVEL";

        $("#editCodigo").val(codigo);
        $("#editTipo").val(tipo).change();
        $("#editStatus").val(status);
        $("#editFuncionario").val(funcionario).trigger("change");

        $("#formEditar").attr("action", url);
        $("#modalEditDispositivo").modal("show");
    });

    $(".btnEquipamentos").click(function () {
        let id = $(this).data("id");
        let codigo = $(this).data("codigo");

        $("#modalEquipamentos").modal("show");
        $("#equipamentosContent").html("<div class='p-4 text-center'><div class='spinner-border text-primary'></div><p class='mt-2'>Carregando itens...</p></div>");

        $.get("/equipamentos/dispositivo/"+id+"/", function(data){
            $("#equipamentosContent").html(data);
        }).fail(function() {
            $("#equipamentosContent").html("<div class='modal-header'><h5 class='modal-title text-danger'>Erro</h5><button class='btn-close' data-bs-dismiss='modal'></button></div><div class='modal-body'>N√£o foi poss√≠vel carregar os equipamentos.</div>");
        });
    });

});
</script>

{% endblock %}