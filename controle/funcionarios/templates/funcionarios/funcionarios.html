{% extends 'core/base.html' %}
{% load static %}

{% block title %}Funcionários{% endblock %}

{% block content %}

<style>
    :root {
        --brand-primary: #1e1e2f; 
        --brand-accent: #d63384;  
        --brand-light: #f8f9fa;
    }

    /* Estilos Gerais */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .page-title {
        font-weight: 700;
        color: var(--brand-primary);
        margin: 0;
    }

    .btn-tech-primary {
        background: linear-gradient(135deg, var(--brand-primary), #3b3b58);
        color: white;
        border: none;
        border-radius: 50px;
        padding: 0.6rem 1.5rem;
        font-weight: 500;
        box-shadow: 0 4px 10px rgba(30, 30, 47, 0.2);
        transition: transform 0.2s;
    }

    .btn-tech-primary:hover {
        transform: translateY(-2px);
        color: white;
        box-shadow: 0 6px 15px rgba(30, 30, 47, 0.3);
    }

    /* Inputs e Filtros */
    .search-container {
        position: relative;
        margin-bottom: 0;
    }

    .search-input {
        border-radius: 50px;
        border: 1px solid #eef0f5;
        background: white;
        padding: 1rem 1rem 1rem 3rem;
        box-shadow: 0 5px 20px rgba(0,0,0,0.03);
        width: 100%;
        transition: all 0.3s;
    }

    .search-input:focus {
        border-color: var(--brand-accent);
        box-shadow: 0 5px 20px rgba(214, 51, 132, 0.15);
        outline: none;
    }

    .search-icon {
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        color: #adb5bd;
        z-index: 10;
    }

    /* Tabela Tech */
    .tech-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 2px 15px rgba(0,0,0,0.04);
        border: none;
        overflow: hidden;
        margin-bottom: 2rem;
    }

    .table-tech thead th {
        background-color: white;
        color: #8898aa;
        text-transform: uppercase;
        font-size: 0.75rem;
        font-weight: 700;
        letter-spacing: 0.5px;
        border-bottom: 1px solid #eef0f5;
        padding: 1.2rem 1rem;
    }

    .table-tech tbody td {
        padding: 1rem;
        vertical-align: middle;
        border-bottom: 1px solid #f5f7fb;
        color: #525f7f;
        font-size: 0.9rem;
    }

    .table-tech tbody tr:hover {
        background-color: #fcfcfd;
    }

    /* Avatar e Badges */
    .avatar-circle {
        width: 35px;
        height: 35px;
        background-color: #eef0f5;
        color: var(--brand-primary);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        margin-right: 12px;
        font-size: 0.9rem;
    }

    .badge-unit {
        background-color: #e3e8f5;
        color: #4a5073;
        font-weight: 600;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 0.8rem;
    }

    /* Tabs Customizadas */
    .nav-tabs {
        border-bottom: 2px solid #eef0f5;
        margin-bottom: 1.5rem;
    }

    .nav-tabs .nav-link {
        border: none;
        color: #8898aa;
        font-weight: 600;
        padding: 1rem 1.5rem;
        transition: all 0.3s;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
    }

    .nav-tabs .nav-link:hover {
        color: var(--brand-primary);
    }

    .nav-tabs .nav-link.active {
        color: var(--brand-primary);
        background: transparent;
        border-bottom: 2px solid var(--brand-primary);
    }

    .nav-tabs .nav-link.text-danger.active {
        color: #dc3545;
        border-bottom-color: #dc3545;
    }

    /* Botões de Ação */
    .btn-action {
        width: 32px;
        height: 32px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        border: none;
        transition: all 0.2s;
        margin-left: 6px;
    }

    .btn-action-history { background-color: #e0f2fe; color: #0ea5e9; }
    .btn-action-history:hover { background-color: #0ea5e9; color: white; }

    .btn-action-edit { background-color: #fdf3e8; color: #f59e0b; }
    .btn-action-edit:hover { background-color: #f59e0b; color: white; }

    .btn-action-delete { background-color: #fee2e2; color: #ef4444; }
    .btn-action-delete:hover { background-color: #ef4444; color: white; }
    
    .btn-action-restore { background-color: #dcfce7; color: #22c55e; }
    .btn-action-restore:hover { background-color: #22c55e; color: white; }

</style>

<div class="container-fluid px-0">
    
    <div class="page-header">
        <h2 class="page-title">Gerenciamento de Funcionários</h2>
        <button class="btn btn-tech-primary" data-bs-toggle="modal" data-bs-target="#modalCriar">
            <i class="bi bi-person-plus me-1"></i> Novo Funcionário
        </button>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-8">
            <div class="search-container">
                <i class="bi bi-search search-icon"></i>
                <input type="text" id="busca" class="search-input" placeholder="Buscar funcionário por nome...">
            </div>
        </div>
        <div class="col-md-4">
            <div class="position-relative">
                <i class="bi bi-building search-icon"></i>
                <select id="filtroUnidade" class="search-input form-select" style="cursor: pointer;">
                    <option value="">Todas as Unidades</option>
                    {% for codigo, nome in unidades %}
                        <option value="{{ codigo }}">{{ nome }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="ativos-tab" data-bs-toggle="tab" data-bs-target="#tab-ativos" type="button">
                <i class="bi bi-person-check me-2"></i>Ativos
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link text-danger" id="demitidos-tab" data-bs-toggle="tab" data-bs-target="#tab-demitidos" type="button">
                <i class="bi bi-person-x me-2"></i>Histórico / Demitidos
            </button>
        </li>
    </ul>

    <div class="tab-content" id="myTabContent">
        
        <div class="tab-pane fade show active" id="tab-ativos">
            <div class="tech-card table-responsive">
                <table class="table table-tech mb-0">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Unidade</th>
                            <th class="text-end pe-4">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="listaAtivos">
                    {% for f in ativos %}
                        <tr data-nome="{{ f.nome|lower }}" data-unidade="{{ f.unidade_trabalho }}">
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar-circle">
                                        {{ f.nome|slice:":1" }}
                                    </div>
                                    <span class="fw-bold text-dark">{{ f.nome }}</span>
                                </div>
                            </td>
                            <td>{{ f.email }}</td>
                            <td>
                                {% if f.unidade_trabalho %}
                                    <span class="badge-unit">
                                        <i class="bi bi-building me-1"></i> {{ f.get_unidade_trabalho_display }}
                                    </span>
                                {% else %}
                                    <span class="text-muted small">—</span>
                                {% endif %}
                            </td>
                            <td class="text-end pe-4">
                                <button class="btn-action btn-action-history btnHistorico" data-id="{{ f.id }}" data-bs-toggle="tooltip" title="Ver Histórico">
                                    <i class="bi bi-clock-history"></i>
                                </button>
                                
                                <button class="btn-action btn-action-edit btnEditar" data-id="{{ f.id }}" data-bs-toggle="tooltip" title="Editar">
                                    <i class="bi bi-pencil-fill" style="font-size: 0.8rem;"></i>
                                </button>

                                <button class="btn-action btn-action-delete btnDemitir" 
                                        data-id="{{ f.id }}" 
                                        data-nome="{{ f.nome }}"
                                        data-bs-toggle="tooltip" title="Demitir">
                                    <i class="bi bi-person-x-fill"></i>
                                </button>
                            </td>
                        </tr>
                    {% empty %}
                        <tr><td colspan="4" class="text-center py-5 text-muted">Nenhum funcionário ativo encontrado.</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-demitidos">
            <div class="tech-card table-responsive">
                <table class="table table-tech mb-0 text-muted">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Data Demissão</th>
                            <th class="text-end pe-4">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="listaInativos">
                    {% for f in demitidos %}
                        <tr data-nome="{{ f.nome|lower }}" data-unidade="{{ f.unidade_trabalho }}">
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar-circle bg-light text-muted">
                                        {{ f.nome|slice:":1" }}
                                    </div>
                                    <span>{{ f.nome }}</span>
                                </div>
                            </td>
                            <td>{{ f.email }}</td>
                            <td><i class="bi bi-calendar-x me-1"></i> {{ f.data_demissao|date:"d/m/Y" }}</td>
                            <td class="text-end pe-4">
                                <button class="btn-action btn-action-history btnHistorico" data-id="{{ f.id }}" data-bs-toggle="tooltip" title="Ver Histórico">
                                    <i class="bi bi-clock-history"></i>
                                </button>
                                <a href="{% url 'funcionarios:reativar_funcionario' f.id %}" 
                                   class="btn-action btn-action-restore"
                                   onclick="return confirm('Deseja recontratar este funcionário?')"
                                   data-bs-toggle="tooltip" title="Recontratar">
                                    <i class="bi bi-person-check-fill"></i>
                                </a>
                            </td>
                        </tr>
                    {% empty %}
                        <tr><td colspan="4" class="text-center py-5 text-muted">Nenhum registro histórico encontrado.</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalCriar" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow">
            <form method="POST" action="{% url 'funcionarios:criar_funcionario' %}">
                {% csrf_token %}
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold text-dark">Novo Funcionário</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold">Nome Completo</label>
                        <input type="text" name="nome" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold">Email Corporativo</label>
                        <input type="email" name="email" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold">Unidade</label>
                        <select name="unidade_trabalho" class="form-select">
                            <option value="">Selecione...</option>
                            {% for codigo, nome in unidades %}
                                <option value="{{ codigo }}">{{ nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-light text-muted" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-tech-primary px-4">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditar" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow">
            <form id="formEditar" method="POST">
                {% csrf_token %}
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold text-dark">Editar Funcionário</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold">Nome</label>
                        <input type="text" id="editNome" name="nome" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold">Email</label>
                        <input type="email" id="editEmail" name="email" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold">Unidade</label>
                        <select id="editUnidade" name="unidade_trabalho" class="form-select">
                            <option value="">Selecione...</option>
                            {% for codigo, nome in unidades %}
                                <option value="{{ codigo }}">{{ nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-light text-muted" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-tech-primary px-4">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalHistorico" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-dark">Inventário do Funcionário</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0" id="conteudoHistorico">
                </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDemitir" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow">
            <form id="formDemitir" method="POST">
                {% csrf_token %}
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold text-danger">Confirmar Demissão</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-dark">Tem certeza que deseja demitir <strong id="nomeDemitir" class="text-danger"></strong>?</p>
                    <div class="alert alert-warning border-0 bg-warning bg-opacity-10 text-warning-emphasis">
                        <small>
                            <i class="bi bi-exclamation-triangle-fill me-1"></i> 
                            Isso irá <strong>desvincular</strong> todos os dispositivos e equipamentos desta pessoa e devolvê-los ao estoque.
                        </small>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-light text-muted" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger px-4">Confirmar Demissão</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    
    // Inicializa Tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    });

    // --- 1. BUSCA POR NOME ---
    const inputBusca = document.getElementById("busca");
    if(inputBusca){
        inputBusca.addEventListener("keyup", function() {
            const termo = this.value.toLowerCase();
            document.querySelectorAll("tbody tr").forEach(row => {
                const nome = row.dataset.nome;
                if(nome) {
                    const unidadeSelecionada = document.getElementById("filtroUnidade").value;
                    const rowUnidade = row.dataset.unidade;
                    const matchNome = nome.includes(termo);
                    const matchUnidade = (unidadeSelecionada === "" || rowUnidade === unidadeSelecionada);
                    row.style.display = (matchNome && matchUnidade) ? "" : "none";
                }
            });
        });
    }

    // --- 2. FILTRO POR UNIDADE ---
    const selectUnidade = document.getElementById("filtroUnidade");
    if(selectUnidade){
        selectUnidade.addEventListener("change", function() {
            inputBusca.dispatchEvent(new Event('keyup'));
        });
    }

    // --- 3. MODAL EDITAR ---
    document.body.addEventListener('click', function(e) {
        const btn = e.target.closest('.btnEditar');
        if (btn) {
            const id = btn.dataset.id;
            const modal = new bootstrap.Modal(document.getElementById('modalEditar'));
            fetch(`/funcionarios/api/get/${id}/`)
                .then(r => r.json())
                .then(data => {
                    document.getElementById("editNome").value = data.nome;
                    document.getElementById("editEmail").value = data.email;
                    document.getElementById("editUnidade").value = data.unidade_trabalho;
                    document.getElementById("formEditar").action = `/funcionarios/editar/${id}/`;
                    modal.show();
                })
                .catch(err => alert("Erro ao carregar dados."));
        }
    });

    // --- 4. MODAL DEMITIR ---
    document.body.addEventListener('click', function(e) {
        const btn = e.target.closest('.btnDemitir');
        if (btn) {
            const id = btn.dataset.id;
            const nome = btn.dataset.nome;
            document.getElementById("nomeDemitir").innerText = nome;
            document.getElementById("formDemitir").action = `/funcionarios/demitir/${id}/`;
            const modal = new bootstrap.Modal(document.getElementById('modalDemitir'));
            modal.show();
        }
    });

    // --- 5. MODAL HISTÓRICO (DESIGN MELHORADO) ---
    document.body.addEventListener('click', function(e) {
        const btn = e.target.closest('.btnHistorico');
        if (btn) {
            const id = btn.dataset.id;
            const modalEl = document.getElementById('modalHistorico');
            const modal = new bootstrap.Modal(modalEl);
            const container = document.getElementById("conteudoHistorico");
            
            // Abre o modal com Loading
            modal.show();
            container.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
                    <p class="mt-3 text-muted fw-bold">Consultando inventário...</p>
                </div>`;

            fetch(`/funcionarios/historico/${id}/`)
                .then(response => response.json())
                .then(data => {
                    // Cabeçalho
                    let html = `
                        <div class="p-4 bg-light border-bottom">
                            <div class="d-flex align-items-center">
                                <div class="avatar-circle text-white me-3 d-flex align-items-center justify-content-center shadow-sm" 
                                     style="width: 55px; height: 55px; font-size: 1.4rem; background: linear-gradient(135deg, #1e1e2f, #3b3b58); border-radius: 50%;">
                                    ${data.nome_funcionario.charAt(0)}
                                </div>
                                <div>
                                    <h5 class="fw-bold text-dark mb-1">${data.nome_funcionario}</h5>
                                    <span class="badge bg-white text-secondary border shadow-sm px-3 py-2 rounded-pill">
                                        <i class="bi bi-building me-1"></i> ${data.unidade}
                                    </span>
                                </div>
                                <div class="ms-auto text-end border-start ps-4">
                                    <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.65rem; letter-spacing: 1px;">Total de Itens</small>
                                    <span class="h3 fw-bold text-primary mb-0">${data.total}</span>
                                </div>
                            </div>
                        </div>
                        <div class="p-3 bg-white" style="min-height: 250px;">
                    `;

                    // Lista
                    if (data.itens.length === 0) {
                        html += `
                            <div class="text-center py-5 opacity-50">
                                <div class="mb-3 bg-light rounded-circle d-inline-flex p-4">
                                    <i class="bi bi-box-seam display-4 text-secondary"></i>
                                </div>
                                <p class="mt-2 fw-bold text-muted">Nenhum equipamento vinculado.</p>
                            </div>
                        `;
                    } else {
                        html += `<div class="d-flex flex-column gap-3">`;
                        data.itens.forEach(item => {
                            let isPrincipal = item.categoria === 'Principal';
                            let iconColor = isPrincipal ? 'text-primary' : 'text-warning';
                            let iconBg = isPrincipal ? 'bg-primary bg-opacity-10' : 'bg-warning bg-opacity-10';
                            let borderColor = isPrincipal ? '#0d6efd' : '#ffc107';

                            html += `
                                <div class="card border-0 shadow-sm rounded-3 overflow-hidden">
                                    <div class="card-body p-3 d-flex align-items-center position-relative">
                                        <div style="position: absolute; left: 0; top: 0; bottom: 0; width: 5px; background-color: ${borderColor};"></div>
                                        
                                        <div class="rounded-circle ${iconBg} ${iconColor} d-flex align-items-center justify-content-center me-3 ms-2" 
                                             style="width: 45px; height: 45px;">
                                            <i class="bi ${item.icone} fs-5"></i>
                                        </div>
                                        
                                        <div class="flex-grow-1">
                                            <h6 class="fw-bold text-dark mb-0">${item.nome}</h6>
                                            <small class="text-muted text-uppercase" style="font-size: 0.75rem;">${item.detalhe}</small>
                                        </div>
                                        
                                        <span class="badge ${isPrincipal ? 'bg-primary' : 'bg-secondary'} rounded-pill px-3">
                                            ${item.categoria}
                                        </span>
                                    </div>
                                </div>
                            `;
                        });
                        html += `</div>`;
                    }
                    html += `</div>`; 
                    container.innerHTML = html;
                })
                .catch(err => {
                    console.error(err);
                    container.innerHTML = `<div class="text-center py-5 text-danger"><i class="bi bi-exclamation-triangle display-4 mb-3 d-block"></i><p class="fw-bold">Erro ao carregar dados.</p></div>`;
                });
        }
    });

});
</script>
{% endblock %}